---
title: "Fin 452 - Analysis of Correlation over time for SPY and Mag 7 stocks"
editor: visual
author: "Alex Hirtle, Moe Moughnieh"
format: 
  html:
    self-contained: true
    embed-resources: true
---

```{r, "Libraries", echo = FALSE, warning = FALSE, message = FALSE}
# This chunk loads all required libraries for further chunks.

library(tidyverse)
library(tidyquant)
library(plotly)
library(slider)
```

```{r, "Pulling Data", echo = FALSE, eval = TRUE, message = FALSE, warning = FALSE}
tick <- c("SPY",
          "XLY",
          "XLC",
          "XLP",
          "XLE",
          "XLF",
          "XLV",
          "XLI",
          "XLK",
          "XLB",
          "XLRE",
          "XLU",
          "AAPL",
          "AMZN",
          "GOOG",
          "NVDA",
          "MSFT",
          "TSLA",
          "META",
          "MAGS")

from_date <- "2013-01-01"
to_date <- "2025-12-31"

data_2013_2024_long <- tidyquant::tq_get(tick, 
                      get = "stock.prices", 
                      complete_cases = TRUE, 
                      from = from_date, 
                      to = to_date) %>%
  dplyr::select(date, symbol, adjusted)

data_2013_2024_wide <- tidyr::pivot_wider(data_2013_2024_long, 
                                          names_from = symbol, values_from = adjusted)
                                        
```

```{r, echo = FALSE, eval = TRUE, message = FALSE, warning = FALSE}

tech_spy <- data_2013_2024_wide %>%
  select(date, SPY, MAGS, XLU) %>%
  mutate(ret_SPY = (SPY / lag(SPY) - 1),
         ret_MAGS = (MAGS / lag(MAGS) - 1),
         ret_XLU = (XLU / lag(XLU) - 1)) %>%
  select(date, ret_SPY, ret_MAGS, ret_XLU) %>%
  na.omit()


tech_spy_cor <- tech_spy %>%
  mutate(cor_mags_spy = pslide_dbl(
    .l = list(ret_SPY, ret_MAGS),
    .f = ~ cor(.x, .y),
    .before = 120,
    .after = 0,
    .complete = TRUE
    ),
    cor_xlu_spy = pslide_dbl(
      .l = list(ret_SPY, ret_XLU),
      .f = ~ cor(.x, .y),
      .before = 120,
      .after = 0,
      .complete = TRUE
    ))


spy_risk <- tech_spy_cor %>%
  mutate(rolling_sd_spy = slide_dbl(
    .x = ret_SPY,
    .f = ~ sd(.x),
    .before = 120,
    .after = 0,
    .complete = TRUE),
    rolling_sd_mags = slide_dbl(
      .x = ret_MAGS,
      .f = ~ sd(.x),
      .before = 120,
      .after = 0,
      .complete = TRUE
    ), 
    rolling_sd_xlu = slide_dbl(
      .x  = ret_XLU,
      .f = ~ sd(.x),
      .before = 120,
      .after = 0,
      .complete = TRUE
    ))

spy_risk_covar <- spy_risk %>%
  mutate(rolling_covar = pslide_dbl(
    .l = list(ret_SPY, ret_MAGS),
    .f = ~ cov(.x, .y),
    .before = 120,
    .after = 0,
    .complete = TRUE
  ),
  rolling_covar_xlu = pslide_dbl(
    .l = list(ret_SPY, ret_XLU),
    .f = ~ cov(.x, .y),
    .before = 120,
    .after = 0,
    .complete = TRUE
  ))

spy_risk_rollingbeta <- spy_risk_covar %>%
  mutate(rolling_beta_mags = rolling_covar / (rolling_sd_spy^2),
         rolling_beta_xlu = rolling_covar_xlu / (rolling_sd_spy^2))

```

```{r, echo = FALSE, eval = TRUE, message = FALSE, warning = FALSE}

volatility_plot <- plot_ly(data = spy_risk) %>%
  add_trace(
    x = ~ date,
    y = ~ rolling_sd_spy,
    type = "scatter",
    mode = "lines",
    name = "SPY volatility") %>%
  add_trace(
    x = ~ date,
    y = ~ rolling_sd_mags,
    type = "scatter",
    mode = "lines",
    name = "MAGS volatility") %>%
  add_trace(
    x = ~ date,
    y = ~ rolling_sd_xlu,
    type = "scatter",
    mode = "lines",
    name = "XLU volatility"
  ) %>%
  layout(
    title = list(text = "Rolling volatility for SPY, MAGS, & XLU. 120 Day Window"),
    xaxis = list(title = "Date"),
    yaxis = list(title = "Volatility")
  )

correl_plot <- plot_ly(data = tech_spy_cor) %>%
  add_trace(
    x = ~ date,
    y = ~ cor_mags_spy,
    type = "scatter",
    mode = "lines",
    name = "SPY - MAGS"
  ) %>%
  add_trace(
    x = ~ date,
    y = ~ cor_xlu_spy,
    type = "scatter",
    mode = "lines",
    name = "SPY - XLU"
  ) %>%
  layout(
    title = list(text = "Rolling correlation for MAGS and XLU on SPY"),
    xaxis = list(title = "Date"),
    yaxis = list(title = "Correlation")
  )


beta_plot <- plot_ly(data = spy_risk_rollingbeta) %>%
  add_trace(
    x = ~ date,
    y = ~ rolling_beta_mags,
    type = "scatter",
    mode = "lines",
    name = "MAGS"
  ) %>%
  add_trace(
    x = ~ date,
    y = ~ rolling_beta_xlu,
    type = "scatter",
    mode = "lines",
    name = "XLU"
  ) %>%
  layout(
    title = list(text = "Rolling beta for MAGS & SPY. 120 Day Window."),
    xaxis = list(title = "Date"),
    yaxis = list(title = "Beta")
  )




```

## Volatility

```{r, eval = TRUE, echo = FALSE, message = FALSE, warning = FALSE}
volatility_plot
```

As showcased above, standard deviation of returns on both the MAGS and SPY indices has significantly increased over the last 2 years. XLU, our utilities baseline varied but from the beginning of the period to the end, stayed fairly level.

In 2025, after Trump's inauguration the market went through a period of extreme uncertainty and variance rose sharply. However, XLU's standard deviation remained in a fairly stable range, being less effected by fear in the wider market.

## Correlation

```{r, eval = TRUE, echo = FALSE, message = FALSE, warning = FALSE}
correl_plot
```

Correlation between SPY and MAGS increased slightly over the period, rising from around 0.8 to 0.85. This increase follows the change in variance of both MAGS and SPY as well. During 2025, correlation spikes for both indices - Following the shift across the market, where most industries went into free fall after Trumps sweeping tariffs were announced. This rise in correlation for both MAGS and XLU is not significant when looking at long term changes, because the market showed co-movement only in large economic shifts, this does not indicate true correlation changed significantly. Ignoring the shock, XLU's correlation with SPY decreased, while MAGS correlation with SPY increased over the period.

## Beta

```{r, eval = TRUE, echo = FALSE, message = FALSE, warning = FALSE}
beta_plot
```

The beta for MAGS appeared to be steadily increasing throughout 2024, meaning that the risk relative to the S&P 500 was increasing, whereas the beta for XLU was decreasing throughout 2024.

The cause-and-effect chain follows that: Because the volatility of MAGS was increasing, the volatility of the S&P 500 was increasing as well to a lesser degree. This is because MAGS stocks are highly weighted in the portfolio, which means that their already high volatility dictate S&P movements. Since XLU has a low correlation with MAGS, the beta falls due to stable volatility while the S&P volatility rises.

## Conclusion

Based on our analysis, we conclude the following:

-   Higher weights of MAGS stocks have led to a higher exposure of tech-sector risks within the S&P 500.

-   This leads to increased co-movement between the S&P 500 and MAGS because market movements are more strongly dictated by MAGS volatility.

-   Increased concentration risk have had a negative impact on diversification within the S&P 500, and could be of concern to those who want to be more protected from tech-sector related risks.
